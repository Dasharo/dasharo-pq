From d55f700035eba51312308523c150e469d667168e Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Micha=C5=82=20Kope=C4=87?= <michal.kopec@3mdeb.com>
Date: Thu, 2 Jun 2022 17:48:42 +0200
Subject: [PATCH 77/80] mb/pcengines/apu2: add variant apu7
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

apu7 is an apu3 with different NICs (Intel i225).

For now, it doesn't support iPXE network booting.

Change-Id: I495879f1527643b217f9facb07dace5d70175a3e
Signed-off-by: Michał Kopeć <michal.kopec@3mdeb.com>
diff --git a/configs/config.pcengines_apu7 b/configs/config.pcengines_apu7
new file mode 100644
index 000000000000..fefa66fd4399
--- /dev/null
+++ b/configs/config.pcengines_apu7
@@ -0,0 +1,30 @@
+# CONFIG_CONSOLE_USE_LOGLEVEL_PREFIX is not set
+# CONFIG_CONSOLE_USE_ANSI_ESCAPES is not set
+CONFIG_AGESA_BINARY_PI_LOCATION=0xFFE00000
+CONFIG_BOARD_PCENGINES_APU7=y
+CONFIG_BOTTOMIO_POSITION=0xD0000000
+CONFIG_CONSOLE_CBMEM_BUFFER_SIZE=0x20000
+CONFIG_DEFAULT_CONSOLE_LOGLEVEL_1=y
+CONFIG_HUDSON_SATA_MODE=2
+CONFIG_I2C_TRANSFER_TIMEOUT_US=500000
+CONFIG_LOCALVERSION="v4.19.0.1"
+CONFIG_MEMTEST_REVISION=y
+CONFIG_MEMTEST_REVISION_ID="0b756257276729c1a12bc1d95e7a1f044894bda2"
+CONFIG_MEMTEST_SECONDARY_PAYLOAD=y
+CONFIG_NO_GFX_INIT=y
+CONFIG_PAYLOAD_CONFIGFILE="$(top)/src/mainboard/$(MAINBOARDDIR)/seabios_config"
+CONFIG_POST_IO_PORT=0x80
+CONFIG_SEABIOS_BOOTORDER_FILE="$(top)/src/mainboard/$(MAINBOARDDIR)/variants/$(CONFIG_VARIANT_DIR)/bootorder"
+CONFIG_SEABIOS_BOOTORDER_IN_FMAP=y
+CONFIG_SEABIOS_DEBUG_LEVEL=0
+CONFIG_SEABIOS_NO_OPROMS=y
+CONFIG_SEABIOS_REVISION=y
+CONFIG_SEABIOS_REVISION_ID="rel-1.16.0.1"
+CONFIG_SEABIOS_SERCON_PORT_ADDR=0x3f8
+CONFIG_SORTBOOTORDER_REVISION=y
+CONFIG_SORTBOOTORDER_REVISION_ID="v4.6.24"
+CONFIG_SORTBOOTORDER_SECONDARY_PAYLOAD=y
+CONFIG_SUBSYSTEM_DEVICE_ID=0x0000
+CONFIG_SUBSYSTEM_VENDOR_ID=0x0000
+CONFIG_TPM2=y
+CONFIG_VENDOR_PCENGINES=y
diff --git a/src/mainboard/pcengines/apu2/Kconfig b/src/mainboard/pcengines/apu2/Kconfig
index 9167f2f0bf08..da13f5750106 100644
--- a/src/mainboard/pcengines/apu2/Kconfig
+++ b/src/mainboard/pcengines/apu2/Kconfig
@@ -1,7 +1,7 @@
 # SPDX-License-Identifier: GPL-2.0-only
 
 if BOARD_PCENGINES_APU2 || BOARD_PCENGINES_APU3 || BOARD_PCENGINES_APU4 || \
-	BOARD_PCENGINES_APU5 || BOARD_PCENGINES_APU6
+	BOARD_PCENGINES_APU5 || BOARD_PCENGINES_APU6 || BOARD_PCENGINES_APU7
 
 config BOARD_SPECIFIC_OPTIONS
 	def_bool y
@@ -30,6 +30,7 @@ config VARIANT_DIR
 	default "apu4" if BOARD_PCENGINES_APU4
 	default "apu5" if BOARD_PCENGINES_APU5
 	default "apu6" if BOARD_PCENGINES_APU6
+	default "apu7" if BOARD_PCENGINES_APU7
 
 config DEVICETREE
 	default "variants/\$(CONFIG_VARIANT_DIR)/devicetree.cb"
@@ -40,10 +41,7 @@ config MAINBOARD_PART_NUMBER
 	default "apu4" if BOARD_PCENGINES_APU4
 	default "apu5" if BOARD_PCENGINES_APU5
 	default "apu6" if BOARD_PCENGINES_APU6
-
-config DEFAULT_CONSOLE_LOGLEVEL
-	int
-	default 1
+	default "apu7" if BOARD_PCENGINES_APU7
 
 config MAX_CPUS
 	int
@@ -75,7 +73,7 @@ config APU2_PINMUX_OFF_C
 config APU2_PINMUX_GPIO0
 	bool "GPIO"
 	depends on BOARD_PCENGINES_APU2 || BOARD_PCENGINES_APU3 || \
-		BOARD_PCENGINES_APU4 || BOARD_PCENGINES_APU6
+		BOARD_PCENGINES_APU4 || BOARD_PCENGINES_APU6 || BOARD_PCENGINES_APU7
 
 config APU2_PINMUX_UART_C
 	bool "UART 0x3e8"
@@ -92,7 +90,7 @@ config APU2_PINMUX_OFF_D
 config APU2_PINMUX_GPIO1
 	bool "GPIO"
 	depends on BOARD_PCENGINES_APU2 || BOARD_PCENGINES_APU3 || \
-		BOARD_PCENGINES_APU4 || BOARD_PCENGINES_APU6
+		BOARD_PCENGINES_APU4 || BOARD_PCENGINES_APU6 || BOARD_PCENGINES_APU7
 
 config APU2_PINMUX_UART_D
 	bool "UART 0x2e8"
diff --git a/src/mainboard/pcengines/apu2/Kconfig.name b/src/mainboard/pcengines/apu2/Kconfig.name
index c5de40a1c46b..42540b48076c 100644
--- a/src/mainboard/pcengines/apu2/Kconfig.name
+++ b/src/mainboard/pcengines/apu2/Kconfig.name
@@ -12,3 +12,6 @@ config BOARD_PCENGINES_APU5
 
 config BOARD_PCENGINES_APU6
 	bool "APU6"
+
+config BOARD_PCENGINES_APU7
+	bool "APU7"
diff --git a/src/mainboard/pcengines/apu2/dsdt.asl b/src/mainboard/pcengines/apu2/dsdt.asl
index 476ff4c799d8..5d642f8a807e 100644
--- a/src/mainboard/pcengines/apu2/dsdt.asl
+++ b/src/mainboard/pcengines/apu2/dsdt.asl
@@ -12,6 +12,8 @@
 #define DEVICE_NAME "apu5
 #elif CONFIG(BOARD_PCENGINES_APU6)
 #define DEVICE_NAME "apu6
+#elif CONFIG(BOARD_PCENGINES_APU7)
+#define DEVICE_NAME "apu7
 #endif
 
 #include <acpi/acpi.h>
diff --git a/src/mainboard/pcengines/apu2/variants/apu7/bootorder b/src/mainboard/pcengines/apu2/variants/apu7/bootorder
new file mode 100644
index 0000000000000000000000000000000000000000..f2dc50a9717e36e2211eb381ef66ae185d5b37da
GIT binary patch
literal 4096
zcmeH_OK!s;5Qek1<U6pAlHy1D+HsRAhOv!ez+y<++`fZVOO0Y~0Gk1S48Q$hK1(fh
zCHoJ4#ZJ^!EXTd5%Yr9RlSXYCot{yX&RWq%)`~W=R<x1Trn6SGk+q_YtQ9?Gk+{?0
z{ozyTQO%XtHxLz98ZV+saoYFH=@yQi*J=RK9A5c8o{~N-x%=PQ-Wf4~rGk9^fft&T
z1x+ly7)od9?&&9hrJj9|aZOcGg;DAS7z%>sOHLPRlFl?scjp|2g`;YXQ$SEVW3E(V
z!)*R09&X?<;_q{iqjEz<qbzoLWCPhiHjoWu1KB_}kPT!5*+4ds4eY|Gk@b24W&sqk
w;8+LjRDHg&?j8Wy<m|w-WzH+`5rYld!*q{b6RR1{n)TBeM}{DS^SiS61@JB1(f|Me

literal 0
HcmV?d00001

diff --git a/src/mainboard/pcengines/apu2/variants/apu7/devicetree.cb b/src/mainboard/pcengines/apu2/variants/apu7/devicetree.cb
new file mode 100644
index 000000000000..e73758c36996
--- /dev/null
+++ b/src/mainboard/pcengines/apu2/variants/apu7/devicetree.cb
@@ -0,0 +1,83 @@
+# SPDX-License-Identifier: GPL-2.0-only
+
+chip northbridge/amd/pi/00730F01/root_complex
+	device cpu_cluster 0 on
+		chip cpu/amd/pi/00730F01
+			device lapic 0 on  end
+		end
+	end
+
+	device domain 0 on
+		subsystemid 0x1022 0x1410 inherit
+
+		chip northbridge/amd/pi/00730F01
+			device pci 0.0 on  end # Root Complex
+			device pci 0.2 off  end # IOMMU
+			device pci 1.0 off  end # Internal Graphics P2P bridge 0x9804
+			device pci 1.1 off  end # Internal Multimedia
+			device pci 2.0 on  end # PCIe Host Bridge
+			device pci 2.1 on  end # mPCIe slot 2 (on GFX lane)
+			device pci 2.2 on  end # LAN3
+			device pci 2.3 on  end # LAN2
+			device pci 2.4 on  end # LAN1
+			device pci 2.5 on  end # mPCIe slot 1
+			device pci 8.0 on  end # Platform Security Processor
+		end	#chip northbridge/amd/pi/00730F01
+
+		chip southbridge/amd/pi/hudson # it is under NB/SB Link, but on the same pci bus
+			device pci 10.0 on  end # XHCI HC0 muxed with EHCI 2
+			device pci 11.0 on  end # SATA
+			device pci 12.0 on  end # USB EHCI0 usb[0:3] is connected
+			device pci 13.0 on  end # USB EHCI1 usb[4:7]
+			device pci 14.0 on  end # SM
+			device pci 14.3 on      # LPC 0x439d
+				chip superio/nuvoton/nct5104d # SIO NCT5104D
+					register "irq_trigger_type" = "0"
+					register "reset_gpios" = "1"
+					device pnp 2e.0 off end
+					device pnp 2e.2 on
+						io 0x60 = 0x3f8
+						irq 0x70 = 4
+					end
+					device pnp 2e.3 on
+						io 0x60 = 0x2f8
+						irq 0x70 = 3
+					end
+					device pnp 2e.10 on
+						# UART C is conditionally turned on
+						io 0x60 = 0x3e8
+						irq 0x70 = 4
+					end
+					device pnp 2e.11 on
+						# UART D is conditionally turned on
+						io 0x60 = 0x2e8
+						irq 0x70 = 3
+					end
+					device pnp 2e.008 off end
+					device pnp 2e.108 on
+						io 0x60 = 0x220
+					end
+					# GPIO0 and GPIO1 are conditionally turned on
+					device pnp 2e.007 on end
+					device pnp 2e.107 on end
+					device pnp 2e.607 off end
+					device pnp 2e.f on end
+				end # SIO NCT5104D
+				chip drivers/pc80/tpm
+					device pnp 0c31.0 on end
+				end # LPC TPM
+			end # LPC 0x439d
+			register "sd_mode" = "3"
+			device pci 14.7 on  end # SD
+			device pci 16.0 on  end # USB EHCI2 usb[8:7] - muxed with XHCI
+		end	#chip southbridge/amd/pi/hudson
+
+		device pci 18.0 on  end
+		device pci 18.1 on  end
+		device pci 18.2 on  end
+		device pci 18.3 on  end
+		device pci 18.4 on  end
+		device pci 18.5 on  end
+
+	end #domain
+end #northbridge/amd/pi/00730F01/root_complex
